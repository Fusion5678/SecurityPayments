version: 2.1

orbs:
  sonarcloud: sonarsource/sonarcloud@1.0.2

jobs:
  sonarqube-analysis:
    docker:
      - image: cimg/openjdk:17.0
    resource_class: medium
    working_directory: ~/project
    environment:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
    
    steps:
      - checkout:
          fetch-depth: 0  # Full git history for better analysis

      # Display project structure safely
      - run:
          name: Display Project Structure
          command: |
            echo "üìÅ Project Structure:"
            find . -type f -name "*.cs" | head -10 || true
            find . \( -type f -name "*.tsx" -o -name "*.ts" \) | head -10 || true
            echo "üéØ Ready for SonarQube analysis"

      # Install .NET SDK 8.0
      - run:
          name: Install .NET SDK
          command: |
            wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
            sudo dpkg -i packages-microsoft-prod.deb
            sudo apt-get update
            sudo apt-get install -y dotnet-sdk-8.0

      # Install Node.js 18
      - run:
          name: Install Node.js
          command: |
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs

      # Cache .NET packages
      - restore_cache:
          keys:
            - dotnet-deps-v1-{{ checksum "PaymentsAPI/PaymentsAPI.csproj" }}
            - dotnet-deps-v1-

      # Cache Node modules  
      - restore_cache:
          keys:
            - node-deps-v1-{{ checksum "payments-frontend/package-lock.json" }}
            - node-deps-v1-

      # Install .NET dependencies
      - run:
          name: Install .NET dependencies
          command: |
            cd PaymentsAPI
            dotnet restore
            echo "‚úÖ .NET packages restored"

      # Install Node dependencies
      - run:
          name: Install Node dependencies
          command: |
            cd payments-frontend
            npm ci
            echo "‚úÖ Node dependencies installed"

      # Save caches for faster future builds
      - save_cache:
          key: dotnet-deps-v1-{{ checksum "PaymentsAPI/PaymentsAPI.csproj" }}
          paths:
            - ~/.nuget/packages

      - save_cache:
          key: node-deps-v1-{{ checksum "payments-frontend/package-lock.json" }}
          paths:
            - payments-frontend/node_modules

      # Build .NET API
      - run:
          name: Build .NET API
          command: |
            cd PaymentsAPI
            echo "üî® Building .NET API..."
            dotnet build --configuration Release --no-restore --verbosity minimal
            echo "‚úÖ API build completed"

      # Build React Frontend
      - run:
          name: Build React Frontend
          command: |
            cd payments-frontend
            echo "üî® Building React Frontend..."
            npm run build
            echo "‚úÖ Frontend build completed"

      # Run ESLint for additional code quality insights
      - run:
          name: Run ESLint Code Quality Check
          command: |
            cd payments-frontend
            echo "üîç Running ESLint analysis..."
            npm run lint || echo "‚ö†Ô∏è ESLint found issues (non-blocking)"
          continue-on-error: true

      # Install SonarScanner for .NET
      - run:
          name: Install SonarScanner for .NET
          command: |
            echo "üì¶ Installing SonarScanner for .NET..."
            dotnet tool install --global dotnet-sonarscanner
            export PATH="$PATH:/home/circleci/.dotnet/tools"
            echo "‚úÖ SonarScanner for .NET installed"

      # Begin analysis
      - run:
          name: SonarScanner Begin
          command: |
            echo "üîç Starting SonarCloud analysis..."
            export PATH="$PATH:/home/circleci/.dotnet/tools"
            dotnet sonarscanner begin \
              /k:"Fusion5678_SecurityPayments" \
              /o:"fusion5678" \
              /d:sonar.host.url="https://sonarcloud.io" \
              /d:sonar.login="$SONAR_TOKEN" \
              /d:sonar.projectName="SecurityPayments" \
              /d:sonar.projectVersion="1.0" \
              /d:sonar.sources="PaymentsAPI,payments-frontend/src" \
              /d:sonar.exclusions="**/node_modules/**,**/bin/**,**/obj/**,**/Migrations/**,**/wwwroot/**,**/*.min.js,**/coverage/**,**/dist/**,**/build/**,**/packages/**,**/.git/**,**/*.Designer.cs,**/*.test.tsx,**/*.test.ts,**/Properties/**,**/*.sln,**/*.csproj" \
              /d:sonar.qualitygate.wait="false"
            echo "‚úÖ SonarScanner analysis started"

      # Build your solution (required for .NET SonarScanner)
      - run:
          name: Build Solution for Analysis
          command: |
            echo "üî® Building solution for SonarCloud analysis..."
            cd PaymentsAPI
            dotnet build --configuration Release
            echo "‚úÖ Solution built for analysis"

      # End analysis
      - run:
          name: SonarScanner End
          command: |
            echo "üèÅ Completing SonarCloud analysis..."
            export PATH="$PATH:/home/circleci/.dotnet/tools"
            dotnet sonarscanner end /d:sonar.login="$SONAR_TOKEN"
            echo "‚úÖ SonarCloud analysis completed"

      # Summary
      - run:
          name: Analysis Complete
          command: |
            echo "üéâ SonarQube analysis completed!"
            echo "üìä Check results at: https://sonarcloud.io"
            echo "üîç Security hotspots and code smells detected"

workflows:
  sonar-analysis:
    jobs:
      - sonarqube-analysis:
          context: SonarCloud
          filters:
            branches:
              only:
                - master
                - dev
                - main